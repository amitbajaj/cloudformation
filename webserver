{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [ {
                "Label": { "default": "Customize the stack" },
                "Parameters": ["AvailabilityZone", "InstanceSize", "KeyName", "IPSegmentForVPC", "IPSegmentForWS", "IPSegmentForWS" ]
                }]
        },
        "AWS::CloudFormation::Designer": {
            "b7f6db35-e984-4793-bbd9-3a6147b2566d": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 2470,
                    "y": 340
                },
                "z": 1,
                "embeds": [],
                "iscontainedinside": [
                    "bbc33f14-b33c-4e1f-a221-39bf0709c6b3"
                ],
                "dependson": [
                    "0449e0b9-56fe-46b0-9f3d-6d1329937203"
                ]
            },
            "0c3fbdb6-d949-4499-b9e0-a0cd6110dcdf": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 2070,
                    "y": 360
                },
                "z": 2,
                "parent": "d3719990-8107-4f41-b0dd-c330686f386e",
                "embeds": [],
                "iscontainedinside": [
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e"
                ]
            },
            "bbc33f14-b33c-4e1f-a221-39bf0709c6b3": {
                "size": {
                    "width": 120,
                    "height": 90
                },
                "position": {
                    "x": 2160,
                    "y": 360
                },
                "z": 2,
                "parent": "d3719990-8107-4f41-b0dd-c330686f386e",
                "embeds": [],
                "iscontainedinside": [
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e"
                ]
            },
            "d3719990-8107-4f41-b0dd-c330686f386e": {
                "size": {
                    "width": 390,
                    "height": 300
                },
                "position": {
                    "x": 2010,
                    "y": 300
                },
                "z": 1,
                "embeds": [
                    "3ecd9447-0e30-4400-b7a2-6ddedf1bbc57",
                    "bbc33f14-b33c-4e1f-a221-39bf0709c6b3",
                    "0c3fbdb6-d949-4499-b9e0-a0cd6110dcdf"
                ]
            },
            "2374f75a-4884-4ee5-b773-f7a709d3098e": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 2140,
                    "y": 130
                },
                "z": 1,
                "embeds": []
            },
            "0449e0b9-56fe-46b0-9f3d-6d1329937203": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 1870,
                    "y": 180
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "2374f75a-4884-4ee5-b773-f7a709d3098e",
                    "0c3fbdb6-d949-4499-b9e0-a0cd6110dcdf"
                ],
                "iscontainedinside": [
                    "3ecd9447-0e30-4400-b7a2-6ddedf1bbc57"
                ]
            },
            "3ecd9447-0e30-4400-b7a2-6ddedf1bbc57": {
                "size": {
                    "width": 120,
                    "height": 80
                },
                "position": {
                    "x": 2160,
                    "y": 470
                },
                "z": 2,
                "parent": "d3719990-8107-4f41-b0dd-c330686f386e",
                "embeds": [],
                "iscontainedinside": [
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e",
                    "d3719990-8107-4f41-b0dd-c330686f386e"
                ]
            },
            "cb0980be-024a-48ae-8a94-5909b88f0082": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 2570,
                    "y": 200
                },
                "z": 1,
                "embeds": []
            },
            "f103d7c6-ae0e-4f9a-b0f6-2d4c147a9a4d": {
                "source": {
                    "id": "d3719990-8107-4f41-b0dd-c330686f386e"
                },
                "target": {
                    "id": "cb0980be-024a-48ae-8a94-5909b88f0082"
                },
                "z": 1
            },
            "2cdf7b17-575f-49b7-bfa2-ce07fe038898": {
                "size": {
                    "width": 120,
                    "height": 120
                },
                "position": {
                    "x": 2320,
                    "y": 70
                },
                "z": 1,
                "embeds": [
                    "7bbb3413-9459-43e5-ba34-d0db44be509f"
                ],
                "iscontainedinside": [
                    "d3719990-8107-4f41-b0dd-c330686f386e"
                ]
            },
            "d5fd8158-c998-4b69-a965-8d6bec486852": {
                "source": {
                    "id": "2cdf7b17-575f-49b7-bfa2-ce07fe038898"
                },
                "target": {
                    "id": "bbc33f14-b33c-4e1f-a221-39bf0709c6b3"
                },
                "z": 2
            },
            "7bbb3413-9459-43e5-ba34-d0db44be509f": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 2350,
                    "y": 100
                },
                "z": 2,
                "parent": "2cdf7b17-575f-49b7-bfa2-ce07fe038898",
                "embeds": [],
                "isassociatedwith": [
                    "cb0980be-024a-48ae-8a94-5909b88f0082"
                ],
                "iscontainedinside": [
                    "2cdf7b17-575f-49b7-bfa2-ce07fe038898",
                    "2cdf7b17-575f-49b7-bfa2-ce07fe038898",
                    "2cdf7b17-575f-49b7-bfa2-ce07fe038898",
                    "2cdf7b17-575f-49b7-bfa2-ce07fe038898",
                    "2cdf7b17-575f-49b7-bfa2-ce07fe038898",
                    "2cdf7b17-575f-49b7-bfa2-ce07fe038898",
                    "2cdf7b17-575f-49b7-bfa2-ce07fe038898"
                ]
            },
            "b8e9427f-72e8-41f6-a887-2ccf52814f01": {
                "source": {
                    "id": "2cdf7b17-575f-49b7-bfa2-ce07fe038898"
                },
                "target": {
                    "id": "3ecd9447-0e30-4400-b7a2-6ddedf1bbc57"
                },
                "z": 2
            }
        }
    },
    "Parameters": {
        "KeyName": {
            "Description": "The EC2 Key Pair to allow SSH access to the instance",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription": "A valid key name should be selected",
            "MinLength": "1"
        },
        "AvailabilityZone": {
            "Description": "The AZ to create the resources in",
            "Type": "AWS::EC2::AvailabilityZone::Name",
            "ConstraintDescription": "A valid availability zone",
            "MinLength": "1"
        },
        "IPSegmentForVPC": {
            "Description": "The CIDR Block range for VPC",
            "Type": "String",
            "MinLength": "1",
            "Default": "10.0.0.0/16"
        },
        "IPSegmentForWS": {
            "Description": "The CIDR Block range for Web Servers",
            "Type": "String",
            "MinLength": "1",
            "Default": "10.0.0.0/28"
        },
        "IPSegmentForFS": {
            "Description": "The CIDR Block range for EFS",
            "Type": "String",
            "MinLength": "1",
            "Default": "10.0.0.16/28"
        },
        "InstanceSize": {
            "Description": "The size of the instance to create",
            "Type": "String",
            "Default": "t2.micro",
            "AllowedValues": [
                "t1.micro",
                "t2.nano",
                "t2.micro",
                "t2.small",
                "t2.medium",
                "t2.large",
                "m1.small",
                "m1.medium",
                "m1.large",
                "m1.xlarge",
                "m2.xlarge",
                "m2.2xlarge",
                "m2.4xlarge",
                "m3.medium",
                "m3.large",
                "m3.xlarge",
                "m3.2xlarge",
                "m4.large",
                "m4.xlarge",
                "m4.2xlarge",
                "m4.4xlarge",
                "m4.10xlarge",
                "c1.medium",
                "c1.xlarge",
                "c3.large",
                "c3.xlarge",
                "c3.2xlarge",
                "c3.4xlarge",
                "c3.8xlarge",
                "c4.large",
                "c4.xlarge",
                "c4.2xlarge",
                "c4.4xlarge",
                "c4.8xlarge",
                "g2.2xlarge",
                "g2.8xlarge",
                "r3.large",
                "r3.xlarge",
                "r3.2xlarge",
                "r3.4xlarge",
                "r3.8xlarge",
                "i2.xlarge",
                "i2.2xlarge",
                "i2.4xlarge",
                "i2.8xlarge",
                "d2.xlarge",
                "d2.2xlarge",
                "d2.4xlarge",
                "d2.8xlarge",
                "hi1.4xlarge",
                "hs1.8xlarge",
                "cr1.8xlarge",
                "cc2.8xlarge",
                "cg1.4xlarge"
            ],
            "ConstraintDescription": "must be a valid EC2 instance type."
        }
    },
    "Resources": {
        "WebServer": {
            "DependsOn": "WebSiteRoot",
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "ImageId": {
                    "Fn::FindInMap": [
                        "AMIRegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "HVM64"
                    ]
                },
                "InstanceInitiatedShutdownBehavior": "stop",
                "InstanceType": {
                    "Ref": "InstanceSize"
                },
                "KeyName": {
                    "Ref": "KeyName"
                },
                "NetworkInterfaces": [
                    {
                        "DeviceIndex": "0",
                        "SubnetId": {
                            "Ref": "WebServerSubnet"
                        },
                        "GroupSet": [
                            {
                                "Ref": "WebServerSG"
                            }
                        ]
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -xe\n",
                                "yum install -y aws-cfn-bootstrap\n",
                                "# Install the files and packages from the metadata\n",
                                "/opt/aws/bin/cfn-init -v ",
                                "         --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                "         --resource WebServer ",
                                "         --configsets Initialize ",
                                "         --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n"
                            ]
                        ]
                    }
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "b7f6db35-e984-4793-bbd9-3a6147b2566d"
                },
                "AWS::CloudFormation::Init": {
                    "configSets": {
                        "Initialize": [
                            "init",
                            "files"
                        ]
                    },
                    "init": {
                        "packages": {
                            "yum": {
                                "httpd": [],
                                "php": []
                            }
                        },
                        "commands": {
                            "01_create_dir": {
                                "command": "sudo mkdir /app"
                            },
                            "02_mount_fs": {
                                "command": {
                                    "Fn::Sub": "sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 ${WebSiteFS}.efs.${AWS::Region}.amazonaws.com:/ /app"
                                }
                            },
                            "03_own_dir": {
                                "command": "sudo chown ec2-user:ec2-user -R /app"
                            },
                            "04_redirect_website_root": {
                                "command": "sudo rmdir html",
                                "cwd" : "/var/www"
                            },
                            "05_create_new_link": {
                                "command": "sudo ln -s /app html",
                                "cwd" : "/var/www"
                            }                            
                        },
                        "services": {
                            "sysvinit": {
                                "httpd": {
                                    "enabled": "true",
                                    "ensureRunning": "true"
                                }
                            }
                        }
                    },
                    "files":{
                        "files":{
                            "/app/index.html":{
                                "content":{
                                    "Fn::Join": ["",[
                                        "<html><head><title>AWS CloudFormation</title</head>",
                                        "<body>",
                                        "<h1>Welcome to CloudFormation",
                                        "<?php\n",
                                        " echo 'This is from PHP';",
                                        "?>",
                                        "</body>",
                                        "</html>"
                                    ]]
                                },
                                "mode":"000600",
                                "owner":"root",
                                "group":"root"
                            }
                        }
                    }
                }
            }
        },
        "WebServerSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "VpcId": {
                    "Ref": "WebServerVPC"
                },
                "GroupDescription": "Allow SSH and Web Access from anywhere",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 2049,
                        "ToPort": 2049,
                        "CidrIp": {
                            "Ref": "IPSegmentForWS"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "0c3fbdb6-d949-4499-b9e0-a0cd6110dcdf"
                }
            }
        },
        "WebServerSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "CidrBlock": {
                    "Ref": "IPSegmentForWS"
                },
                "MapPublicIpOnLaunch": "true",
                "VpcId": {
                    "Ref": "WebServerVPC"
                },
                "AvailabilityZone": {"Ref": "AvailabilityZone"}
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "bbc33f14-b33c-4e1f-a221-39bf0709c6b3"
                }
            }
        },
        "WebServerVPC": {
            "Type": "AWS::EC2::VPC",
            "Description": "VPC to host the resources",
            "Properties": {
                "CidrBlock": {
                    "Ref": "IPSegmentForVPC"
                },
                "EnableDnsSupport": "true",
                "EnableDnsHostnames": "true"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "d3719990-8107-4f41-b0dd-c330686f386e"
                }
            }
        },
        "WebSiteFS": {
            "Type": "AWS::EFS::FileSystem",
            "Properties": {},
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "2374f75a-4884-4ee5-b773-f7a709d3098e"
                }
            }
        },
        "WebSiteRoot": {
            "Type": "AWS::EFS::MountTarget",
            "Properties": {
                "FileSystemId": {
                    "Ref": "WebSiteFS"
                },
                "SubnetId": {
                    "Ref": "EFSSubnet"
                },
                "SecurityGroups": [
                    {
                        "Ref": "WebServerSG"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "0449e0b9-56fe-46b0-9f3d-6d1329937203"
                }
            }
        },
        "EFSSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "WebServerVPC"
                },
                "CidrBlock": {
                    "Ref": "IPSegmentForFS"
                },
                "MapPublicIpOnLaunch": "false",
                "AvailabilityZone": {"Ref": "AvailabilityZone"}
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "3ecd9447-0e30-4400-b7a2-6ddedf1bbc57"
                }
            }
        },
        "VPCIG": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {},
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "cb0980be-024a-48ae-8a94-5909b88f0082"
                }
            }
        },
        "VPCIGAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "WebServerVPC"
                },
                "InternetGatewayId": {
                    "Ref": "VPCIG"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "f103d7c6-ae0e-4f9a-b0f6-2d4c147a9a4d"
                }
            }
        },
        "RouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "WebServerVPC"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "2cdf7b17-575f-49b7-bfa2-ce07fe038898"
                }
            }
        },
        "SubnetToRouteTable": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "RouteTable"
                },
                "SubnetId": {
                    "Ref": "WebServerSubnet"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "d5fd8158-c998-4b69-a965-8d6bec486852"
                }
            }
        },
        "InternetRoute": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "RouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "VPCIG"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "7bbb3413-9459-43e5-ba34-d0db44be509f"
                }
            }
        },
        "EFSSubnetToRouteTable": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "RouteTable"
                },
                "SubnetId": {
                    "Ref": "EFSSubnet"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "b8e9427f-72e8-41f6-a887-2ccf52814f01"
                }
            }
        }
    },
    "Mappings": {
        "AMIRegionMap": {
            "us-east-1": {
                "HVM64": "ami-04681a1dbd79675a5"
            },
            "us-east-2": {
                "HVM64": "ami-0b59bfac6be064b78"
            },
            "us-west-1": {
                "HVM64": "ami-0782017a917e973e7"
            },
            "us-west-2": {
                "HVM64": "ami-6cd6f714"
            },
            "ap-south-1": {
                "HVM64": "ami-0912f71e06545ad88"
            },
            "ap-notheast-2": {
                "HVM64": "ami-0a10b2721688ce9d2"
            },
            "ap-southeast-1": {
                "HVM64": "ami-01da99628f381e50a"
            },
            "ap-southeast-2": {
                "HVM64": "ami-00e17d1165b9dd3ec"
            },
            "ap-northeast-1": {
                "HVM64": "ami-08847abae18baa040"
            },
            "ca-central-1": {
                "HVM64": "ami-ce1b96aa"
            },
            "eu-central-1": {
                "HVM64": "ami-0f5dbc86dd9cbf7a8"
            },
            "eu-west-1": {
                "HVM64": "ami-0bdb1d6c15a40392c"
            },
            "eu-west-2": {
                "HVM64": "ami-e1768386"
            },
            "eu-west-3": {
                "HVM64": "ami-06340c8c12baa6a09"
            },
            "sa-east-1": {
                "HVM64": "ami-0ad7b0031d41ed4b9"
            }
        }
    },
    "Outputs": {
        "MountTargetID": {
            "Description": "Mount target ID",
            "Value": {
                "Ref": "WebSiteRoot"
            }
        },
        "FileSystemID": {
            "Description": "File system ID",
            "Value": {
                "Ref": "WebSiteFS"
            }
        }
    }
}